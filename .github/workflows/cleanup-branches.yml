name: Branch Cleanup

on:
  pull_request:
    types: [closed]
  schedule:
    # Run weekly on Sundays at 2 AM
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Delete merged branch
        if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          if [ "$BRANCH_NAME" != "main" ] && [ "$BRANCH_NAME" != "develop" ]; then
            echo "Deleting merged branch: $BRANCH_NAME"
            git push origin --delete "$BRANCH_NAME" || echo "Branch already deleted or error occurred"
          else
            echo "Skipping protected branch: $BRANCH_NAME"
          fi

      - name: Clean up stale branches
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "Fetching all branches..."
          git fetch --all --prune
          
          # Get all remote branches except main and develop
          BRANCHES=$(git branch -r | grep -v 'HEAD' | grep -v 'main' | grep -v 'develop' | sed 's/origin\///')
          
          for BRANCH in $BRANCHES; do
            # Get last commit date
            LAST_COMMIT=$(git log -1 --format=%ct origin/$BRANCH 2>/dev/null || echo 0)
            CURRENT_TIME=$(date +%s)
            DAYS_OLD=$(( ($CURRENT_TIME - $LAST_COMMIT) / 86400 ))
            
            # Delete branches older than 30 days with no activity
            if [ $DAYS_OLD -gt 30 ]; then
              echo "Deleting stale branch: $BRANCH (last activity: $DAYS_OLD days ago)"
              git push origin --delete "$BRANCH" || echo "Failed to delete $BRANCH"
            else
              echo "Keeping branch: $BRANCH (last activity: $DAYS_OLD days ago)"
            fi
          done

      - name: Summary
        run: |
          echo "Branch cleanup completed successfully"
          git branch -r
